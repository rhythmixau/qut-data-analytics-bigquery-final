WITH trap_data AS (
  SELECT
    TERRITORIAL_AUTHORITY,
    TOWN_CITY,
    SUBURB_LOCALITY,
    STRIKED_DATE,
    FORMAT_DATE('%Y', CAST(STRIKED_DATE AS TIMESTAMP)) AS STRIKED_YEAR,
    NUM_KILLS,
    NUM_TRAPS
  FROM `qut-data-analytics-capstone`.`goodnature`.`fct_nz_daily_kills`
  WHERE STRIKED_DATE >= '2017-01-01'
),

kill_summary AS (
  SELECT
    TERRITORIAL_AUTHORITY,
    TOWN_CITY,
    SUBURB_LOCALITY,
    STRIKED_YEAR,
    SUM(NUM_KILLS) AS TOTAL_KILLS,
    SUM(NUM_TRAPS) AS TOTAL_TRAPS
  FROM trap_data
  GROUP BY
    TERRITORIAL_AUTHORITY,
    TOWN_CITY,
    SUBURB_LOCALITY,
    STRIKED_YEAR),

  kill_ranks AS (
  SELECT
    DENSE_RANK() OVER (PARTITION BY STRIKED_YEAR ORDER BY TOTAL_KILLS DESC) AS KILL_RANK,
    STRIKED_YEAR,
    TERRITORIAL_AUTHORITY,
    TOWN_CITY,
    SUBURB_LOCALITY,
    TOTAL_KILLS,
    TOTAL_TRAPS
  FROM kill_summary
  )

  SELECT
    KILL_RANK,
    STRIKED_YEAR,
    TERRITORIAL_AUTHORITY,
    TOWN_CITY,
    SUBURB_LOCALITY,
    TOTAL_KILLS,
    TOTAL_TRAPS
  FROM kill_ranks
  WHERE KILL_RANK <= 10
  ORDER BY STRIKED_YEAR, KILL_RANK